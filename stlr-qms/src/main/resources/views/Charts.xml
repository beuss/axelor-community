<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_5.0.xsd">
	<chart name="qms-improvement-form-chart" title="Monthly statistics" onInit="action-qms-improvement-form-record-monthly-stats"> 
		<search-fields> 
			<field type="date" name="fromDate" title="From Date" x-required="true"/>
			<field type="date" name="toDate" title="To Date" x-required="true"/>
		</search-fields>
		<dataset type="sql">
		<![CDATA[
		SELECT
			to_char(dates.month, 'YYYYMM') as month,
			confirmed.cnt as confirmedcnt, assigned.cnt as assignedcnt, analyzed.cnt as analyzedcnt, corrected.cnt as correctedcnt,
			assessed.cnt as assessedcnt, closed.cnt as closedcnt, canceled.cnt as canceledcnt
		FROM
			generate_series(DATE(:fromDate), DATE(:toDate), '1 month') as dates(month)
			FULL JOIN
			(
				SELECT COUNT(*) as cnt, to_char(confirmation_date, 'YYYYMM') as month
				FROM qms_improvement_form WHERE company = :_activeCompany AND confirmation_date BETWEEN DATE(:fromDate) AND DATE(:toDate)
				GROUP BY to_char(confirmation_date, 'YYYYMM')
			) as confirmed ON (confirmed.month = to_char(dates.month, 'YYYYMM'))
			FULL JOIN
			(
				SELECT COUNT(*) as cnt, to_char(assignment_date, 'YYYYMM') as month
				FROM qms_improvement_form WHERE company = :_activeCompany AND assignment_date BETWEEN DATE(:fromDate) AND DATE(:toDate)
				GROUP BY to_char(assignment_date, 'YYYYMM')
			) as assigned ON (assigned.month = to_char(dates.month, 'YYYYMM'))
			FULL JOIN
			(
				SELECT COUNT(*) as cnt, to_char(analysis_date, 'YYYYMM') as month
				FROM qms_improvement_form WHERE company = :_activeCompany AND analysis_date BETWEEN DATE(:fromDate) AND DATE(:toDate)
				GROUP BY to_char(analysis_date, 'YYYYMM')
			) as analyzed ON (analyzed.month = to_char(dates.month, 'YYYYMM'))
			FULL JOIN
			(
				SELECT COUNT(*) as cnt, to_char(correction_date, 'YYYYMM') as month
				FROM qms_improvement_form WHERE company = :_activeCompany AND correction_date BETWEEN DATE(:fromDate) AND DATE(:toDate)
				GROUP BY to_char(correction_date, 'YYYYMM')
			) as corrected ON (corrected.month = to_char(dates.month, 'YYYYMM'))
			FULL JOIN
			(
				SELECT COUNT(*) as cnt, to_char(post_correction_assessment_date, 'YYYYMM') as month
				FROM qms_improvement_form WHERE company = :_activeCompany AND post_correction_assessment_date BETWEEN DATE(:fromDate) AND DATE(:toDate)
				GROUP BY to_char(post_correction_assessment_date, 'YYYYMM')
			) as assessed ON (assessed.month = to_char(dates.month, 'YYYYMM'))
			FULL JOIN
			(
				SELECT COUNT(*) as cnt, to_char(closing_date, 'YYYYMM') as month
				FROM qms_improvement_form WHERE company = :_activeCompany AND closing_date BETWEEN DATE(:fromDate) AND DATE(:toDate)
				GROUP BY to_char(closing_date, 'YYYYMM')
			) as closed ON (closed.month = to_char(dates.month, 'YYYYMM'))
			FULL JOIN
			(
				SELECT COUNT(*) as cnt, to_char(cancelation_date, 'YYYYMM') as month
				FROM qms_improvement_form WHERE company = :_activeCompany AND cancelation_date BETWEEN DATE(:fromDate) AND DATE(:toDate)
				GROUP BY to_char(cancelation_date, 'YYYYMM')
			) as canceled ON (canceled.month = to_char(dates.month, 'YYYYMM'))
		ORDER BY
		    month
		]]>
		</dataset>
		<category key="month" type="text"/>
		<series key="confirmedcnt" type="bar" title="Confirmed forms"/>
		<series key="assignedcnt" type="bar" title="Assigned forms"/>
		<series key="analyzedcnt" type="bar" title="Analyzed forms"/>
		<series key="correctedcnt" type="bar" title="Corrected forms"/>
		<series key="assessedcnt" type="bar" title="Assessed forms"/>
		<series key="closedcnt" type="bar" title="Closed forms"/>
		<series key="canceledcnt" type="bar" title="Canceled forms"/>
	</chart>

	<action-record name="action-qms-improvement-form-record-monthly-stats" model="com.axelor.apps.qms.db.ImprovementForm">
		<field name="toDate" expr="eval:LocalDate.now()" />
		<field name="fromDate" expr="eval:LocalDate.now().minusMonths(12)" />
	</action-record>
</object-views>